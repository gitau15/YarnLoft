// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                String               @id @default(cuid())
  email             String               @unique
  passwordHash      String?              @map("password_hash")
  name              String
  avatarUrl         String?              @map("avatar_url")
  bio               String?              @db.Text
  location          String?
  ravelryUsername   String?              @map("ravelry_username")
  preferredCrafts   PreferredCrafts      @default(BOTH)
  skillLevel        SkillLevel           @default(BEGINNER)
  profileVisibility ProfileVisibility    @default(PUBLIC)
  emailVerified     DateTime?            @map("email_verified")
  image             String?
  createdAt         DateTime             @default(now()) @map("created_at")
  updatedAt         DateTime             @updatedAt @map("updated_at")

  accounts     Account[]
  sessions     Session[]
  orders       Order[]
  stashItems   StashItem[]
  projects     Project[]
  carts        Cart[]

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Product {
  id                String      @id @default(cuid())
  name              String
  brand             String
  colorway          String
  description       String      @db.Text
  price             Decimal     @db.Decimal(10, 2)
  weightCategory    YarnWeight  @map("weight_category")
  fiberContent      String      @map("fiber_content")
  yardage           Int
  meters            Int
  gauge             String?
  needleSize        String?     @map("needle_size")
  careInstructions  String?     @db.Text @map("care_instructions")
  stockQuantity     Int         @default(0) @map("stock_quantity")
  lowStockThreshold Int         @default(5) @map("low_stock_threshold")
  isActive          Boolean     @default(true) @map("is_active")
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  images         ProductImage[]
  orderItems     OrderItem[]
  stashItems     StashItem[]
  cartItems      CartItem[]

  @@map("products")
}

model ProductImage {
  id        String @id @default(cuid())
  productId String @map("product_id")
  url       String
  alt       String
  isMain    Boolean @default(false) @map("is_main")
  order     Int     @default(0)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_images")
}

model StashItem {
  id              String       @id @default(cuid())
  userId          String       @map("user_id")
  productId       String?      @map("product_id")
  customName      String?      @map("custom_name")
  quantity        Int
  quantityUnit    QuantityUnit @map("quantity_unit")
  purchaseDate    DateTime?    @map("purchase_date")
  purchasePrice   Decimal?     @db.Decimal(10, 2) @map("purchase_price")
  purchaseLocation String?     @map("purchase_location")
  storageLocation String?      @map("storage_location")
  dyeLot          String?      @map("dye_lot")
  notes           String?      @db.Text
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  user   User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product?      @relation(fields: [productId], references: [id])
  photos  StashItemPhoto[]
  projects Project[]     @relation(fields: [usedStashItems], references: [id])

  @@map("stash_items")
}

model StashItemPhoto {
  id         String @id @default(cuid())
  stashItemId String @map("stash_item_id")
  url        String
  alt        String
  order      Int    @default(0)

  stashItem StashItem @relation(fields: [stashItemId], references: [id], onDelete: Cascade)

  @@map("stash_item_photos")
}

model Order {
  id              String        @id @default(cuid())
  userId          String        @map("user_id")
  status          OrderStatus   @default(PENDING)
  totalAmount     Decimal       @db.Decimal(10, 2) @map("total_amount")
  currency        String        @default("USD")
  shippingAddress Json          @map("shipping_address")
  billingAddress  Json          @map("billing_address")
  paymentMethod   PaymentMethod @map("payment_method")
  paymentId       String?       @map("payment_id")
  shippedAt       DateTime?     @map("shipped_at")
  deliveredAt     DateTime?     @map("delivered_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  user  User        @relation(fields: [userId], references: [id])
  items OrderItem[]

  @@map("orders")
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String  @map("order_id")
  productId String  @map("product_id")
  quantity  Int
  price     Decimal @db.Decimal(10, 2)

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("order_items")
}

model Pattern {
  id                  String      @id @default(cuid())
  name                String
  designer            String
  description         String      @db.Text
  difficultyLevel     SkillLevel  @map("difficulty_level")
  price               Decimal     @db.Decimal(10, 2)
  isFree              Boolean     @default(false) @map("is_free")
  patternType         PatternType @map("pattern_type")
  requiredYarnWeight  String?     @map("required_yarn_weight")
  requiredYarnAmount  String?     @map("required_yarn_amount")
  gauge               String?
  needleSize          String?     @map("needle_size")
  downloadUrl         String?     @map("download_url")
  coverImageUrl       String      @map("cover_image_url")
  isActive            Boolean     @default(true) @map("is_active")
  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @updatedAt @map("updated_at")

  images   PatternImage[]
  projects Project[]

  @@map("patterns")
}

model PatternImage {
  id        String @id @default(cuid())
  patternId String @map("pattern_id")
  url       String
  alt       String
  order     Int    @default(0)

  pattern Pattern @relation(fields: [patternId], references: [id], onDelete: Cascade)

  @@map("pattern_images")
}

model Project {
  id              String        @id @default(cuid())
  userId          String        @map("user_id")
  patternId       String?       @map("pattern_id")
  title           String
  description     String        @db.Text
  status          ProjectStatus @default(PLANNING)
  startedAt       DateTime?     @map("started_at")
  finishedAt      DateTime?     @map("finished_at")
  notes           String?       @db.Text
  modifications   String?       @db.Text
  usedStashItems  String[]      @map("used_stash_items")
  likesCount      Int           @default(0) @map("likes_count")
  isPublic        Boolean       @default(true) @map("is_public")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  pattern  Pattern?      @relation(fields: [patternId], references: [id])
  photos   ProjectPhoto[]
  stashItems StashItem[] @relation(fields: [id], references: [id])

  @@map("projects")
}

model ProjectPhoto {
  id        String @id @default(cuid())
  projectId String @map("project_id")
  url       String
  alt       String
  order     Int    @default(0)

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("project_photos")
}

model Cart {
  id        String   @id @default(cuid())
  userId    String?  @map("user_id")
  sessionId String?  @map("session_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user  User      @relation(fields: [userId], references: [id])
  items CartItem[]

  @@unique([sessionId])
}

model CartItem {
  id        String @id @default(cuid())
  cartId    String @map("cart_id")
  productId String @map("product_id")
  quantity  Int

  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("cart_items")
}

// Enums
enum PreferredCrafts {
  KNITTING
  CROCHETING
  BOTH
}

enum SkillLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum ProfileVisibility {
  PUBLIC
  PRIVATE
  FRIENDS_ONLY
}

enum YarnWeight {
  LACE
  FINGERING
  SPORT
  DK
  WORSTED
  BULKY
  SUPER_BULKY
}

enum QuantityUnit {
  SKEINS
  YARDS
  METERS
  GRAMS
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentMethod {
  STRIPE
  DARAJA
}

enum PatternType {
  KNITTING
  CROCHETING
  BOTH
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  FINISHED
  HIBERNATING
}